generator client {
  provider = "prisma-client-js"
}

enum MemoryType {
  FACT
  PREFERENCE
  LOG_EVENT
  REFERENCE
}

enum UserRole {
  USER
  ADMIN
}

enum RelationType {
  semantic
  topical
  temporal
}

enum OrgRole {
  ADMIN
  EDITOR
  VIEWER
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SourceType {
  EXTENSION
  DOCUMENT
  API
  INTEGRATION
}

enum AccountType {
  PERSONAL
  ORGANIZATION
}

enum IntegrationStatus {
  ACTIVE
  PAUSED
  ERROR
  RATE_LIMITED
  TOKEN_EXPIRED
  DISCONNECTED
}

enum StorageStrategy {
  METADATA_ONLY
  FULL_CONTENT
}

enum SyncFrequency {
  REALTIME
  FIFTEEN_MIN
  HOURLY
  DAILY
  MANUAL
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum MeetingStatus {
  JOINING
  IN_MEETING
  PROCESSING
  COMPLETED
  FAILED
}

enum BriefingType {
  DAILY_DIGEST
  WEEKLY_SYNTHESIS
  TREND_ALERT
  TEAM_REPORT
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String               @id @default(uuid()) @db.Uuid
  email                    String?              @unique
  password_hash            String?
  role                     UserRole             @default(USER)
  account_type             AccountType          @default(PERSONAL)
  created_at               DateTime             @default(now())
  updated_at               DateTime             @default(now()) @updatedAt

  // 2FA fields
  two_factor_enabled       Boolean              @default(false)
  two_factor_secret        String?              // Encrypted TOTP secret
  two_factor_backup_codes  String[]             @default([]) // Hashed backup codes

  memories                 Memory[]
  memory_snapshots         MemorySnapshot[]
  token_usage              TokenUsage[]
  profile                  UserProfile?
  browsing_summaries       BrowsingSummary[]
  audit_logs               AuditLog[]
  organization_memberships OrganizationMember[]
  uploaded_documents       Document[]
  integrations             UserIntegration[]
  meetings                 Meeting[]
  intelligence_briefings   IntelligenceBriefing[]
  notification_preferences NotificationPreferences?

  @@map("users")
}

model Organization {
  id          String               @id @default(uuid()) @db.Uuid
  name        String
  slug        String               @unique
  description String?
  created_at  DateTime             @default(now())
  updated_at  DateTime             @updatedAt

  // Enterprise profile fields
  industry      String?
  team_size     String?              // "1-10", "11-50", "51-200", "200+"
  logo          String?              // URL to uploaded logo
  website       String?
  street_address String?
  city          String?
  state_region  String?
  postal_code   String?
  country       String?
  timezone      String?

  // Billing fields
  legal_name     String?
  billing_email  String?
  billing_address Json?              // Full address object
  vat_tax_id     String?
  plan           String              @default("free") // "free", "pro", "enterprise"

  // Security fields
  data_residency   String            @default("auto")
  require_2fa      Boolean           @default(false)
  session_timeout  String            @default("7d")
  password_policy  String            @default("standard")
  audit_retention  String            @default("90d")
  ip_allowlist     String[]          @default([])
  sso_enabled      Boolean           @default(false)
  sso_config       Json?

  // Integration sync settings (org-wide defaults)
  default_sync_frequency    SyncFrequency  @default(HOURLY)
  custom_sync_interval_min  Int?           // Custom interval in minutes (overrides default_sync_frequency if set)

  // Setup tracking
  setup_completed_steps  String[]    @default([])
  setup_started_at       DateTime?
  setup_completed_at     DateTime?
  security_prompt_shown  Boolean     @default(false)

  // Relations
  members      OrganizationMember[]
  documents    Document[]
  memories     Memory[]
  invitations  OrganizationInvitation[]
  integrations OrganizationIntegration[]
  intelligence_briefings IntelligenceBriefing[]
  meetings     Meeting[]

  @@map("organizations")
}

model OrganizationMember {
  id              String       @id @default(uuid()) @db.Uuid
  organization_id String       @db.Uuid
  user_id         String       @db.Uuid
  role            OrgRole      @default(VIEWER)
  created_at      DateTime     @default(now())
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, user_id])
  @@index([organization_id])
  @@index([user_id])
  @@map("organization_members")
}

model OrganizationInvitation {
  id              String       @id @default(uuid()) @db.Uuid
  organization_id String       @db.Uuid
  email           String
  role            OrgRole      @default(VIEWER)
  invited_by      String       @db.Uuid
  token           String       @unique
  expires_at      DateTime
  accepted_at     DateTime?
  created_at      DateTime     @default(now())
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, email])
  @@index([token])
  @@index([organization_id])
  @@map("organization_invitations")
}

model OrganizationIntegration {
  id               String            @id @default(uuid()) @db.Uuid
  organization_id  String            @db.Uuid
  provider         String            // "slack", "google_drive", etc.
  access_token     String            // Encrypted
  refresh_token    String?           // Encrypted
  token_expires_at DateTime?
  config           Json?
  status           IntegrationStatus @default(ACTIVE)
  storage_strategy StorageStrategy   @default(FULL_CONTENT)
  sync_frequency   SyncFrequency     @default(HOURLY)
  last_sync_at     DateTime?
  last_error       String?
  webhook_id       String?           // External webhook registration ID
  connected_by     String            @db.Uuid
  connected_at     DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  organization     Organization      @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, provider])
  @@index([organization_id])
  @@index([status])
  @@map("organization_integrations")
}

model UserIntegration {
  id               String            @id @default(uuid()) @db.Uuid
  user_id          String            @db.Uuid
  provider         String            // "google_drive", "slack", etc.
  access_token     String            // Encrypted
  refresh_token    String?           // Encrypted
  token_expires_at DateTime?
  config           Json?             // User-specific settings
  status           IntegrationStatus @default(ACTIVE)
  storage_strategy StorageStrategy   @default(FULL_CONTENT)
  sync_frequency   SyncFrequency     @default(HOURLY)
  last_sync_at     DateTime?
  last_error       String?
  webhook_id       String?           // External webhook registration ID
  connected_at     DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  user             User              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, provider])
  @@index([user_id])
  @@index([status])
  @@map("user_integrations")
}

model IntegrationRegistry {
  id            String   @id @default(uuid()) @db.Uuid
  provider      String   @unique
  enabled       Boolean  @default(true)
  allowed_plans String[] @default([]) // Empty = all plans allowed
  default_config Json    @default("{}")
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@map("integration_registry")
}

model IntegrationSyncJob {
  id               String        @id @default(uuid()) @db.Uuid
  integration_id   String
  integration_type String        // 'user' | 'organization'
  provider         String
  mode             String        // 'full' | 'incremental' | 'webhook'
  status           SyncJobStatus @default(PENDING)
  started_at       DateTime      @default(now())
  completed_at     DateTime?
  resources_found  Int           @default(0)
  resources_synced Int           @default(0)
  resources_failed Int           @default(0)
  error_message    String?
  error_details    Json?
  cursor           String?       // For resumable syncs

  @@index([integration_id, integration_type])
  @@index([status])
  @@index([started_at])
  @@map("integration_sync_jobs")
}

model SyncedResource {
  id               String   @id @default(uuid()) @db.Uuid
  integration_id   String
  integration_type String   // 'user' | 'organization'
  external_id      String   // ID in the external system
  resource_type    String   // 'file', 'message', 'page', etc.
  content_hash     String   // For change detection
  memory_id        String?  @db.Uuid // Link to created memory
  last_synced_at   DateTime @default(now())
  excluded         Boolean  @default(false) // If true, skip during resync
  excluded_at      DateTime? // When it was excluded
  excluded_by      String?  @db.Uuid // User who excluded it

  @@unique([integration_id, integration_type, external_id])
  @@index([integration_id, integration_type])
  @@index([memory_id])
  @@index([excluded])
  @@map("synced_resources")
}

model Document {
  id               String         @id @default(uuid()) @db.Uuid
  organization_id  String         @db.Uuid
  uploader_id      String         @db.Uuid
  filename         String
  original_name    String
  mime_type        String
  file_size        Int
  storage_path     String
  storage_provider String         @default("local")
  status           DocumentStatus @default(PENDING)
  error_message    String?
  page_count       Int?
  metadata         Json?
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt
  organization     Organization   @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  uploader         User           @relation(fields: [uploader_id], references: [id], onDelete: Cascade)
  chunks           DocumentChunk[]

  @@index([organization_id])
  @@index([uploader_id])
  @@index([status])
  @@index([organization_id, status])
  @@map("documents")
}

model DocumentChunk {
  id           String   @id @default(uuid()) @db.Uuid
  document_id  String   @db.Uuid
  chunk_index  Int
  content      String
  page_number  Int?
  char_start   Int?
  char_end     Int?
  memory_id    String?  @db.Uuid
  created_at   DateTime @default(now())
  document     Document @relation(fields: [document_id], references: [id], onDelete: Cascade)
  memory       Memory?  @relation(fields: [memory_id], references: [id], onDelete: SetNull)

  @@unique([document_id, chunk_index])
  @@index([document_id])
  @@index([memory_id])
  @@map("document_chunks")
}

model AuditLog {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   @db.Uuid
  event_type        String
  event_category    String
  action            String
  metadata          Json?
  ip_address        String?
  user_agent        String?
  created_at        DateTime @default(now())
  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([event_category])
  @@index([created_at])
  @@map("audit_logs")
}

model Memory {
  id                     String               @id @default(uuid()) @db.Uuid
  user_id                String               @db.Uuid
  source                 String
  url                    String?
  title                  String?
  content                String
  canonical_text         String?
  canonical_hash         String?
  memory_type            MemoryType           @default(LOG_EVENT)
  confidence_score       Float                @default(0.5)
  timestamp              BigInt
  created_at             DateTime             @default(now())
  full_content           String?
  page_metadata          Json?
  importance_score       Float?               @default(0.0)
  access_count           Int                  @default(0)
  last_accessed          DateTime             @default(now())
  source_type            SourceType?          @default(EXTENSION)
  organization_id        String?              @db.Uuid
  user                   User                 @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization           Organization?        @relation(fields: [organization_id], references: [id], onDelete: SetNull)
  related_memories       MemoryRelation[]     @relation("MemoryRelations")
  related_to_memories    MemoryRelation[]     @relation("RelatedMemories")
  query_related_memories QueryRelatedMemory[]
  document_chunks        DocumentChunk[]

  @@index([user_id])
  @@index([created_at])
  @@index([user_id, created_at])
  @@index([canonical_hash])
  @@index([url])
  @@index([memory_type])
  @@index([user_id, importance_score])
  @@index([user_id, memory_type])
  @@index([last_accessed])
  @@index([organization_id])
  @@index([source_type])
  @@unique([user_id, canonical_hash])
  @@map("memories")
}

model MemoryRelation {
  id                String       @id @default(uuid()) @db.Uuid
  memory_id         String       @db.Uuid
  related_memory_id String       @db.Uuid
  similarity_score  Float
  relation_type     RelationType @default(semantic)
  created_at        DateTime     @default(now())
  memory            Memory       @relation("MemoryRelations", fields: [memory_id], references: [id], onDelete: Cascade)
  related_memory    Memory       @relation("RelatedMemories", fields: [related_memory_id], references: [id], onDelete: Cascade)

  @@unique([memory_id, related_memory_id])
  @@index([memory_id])
  @@index([related_memory_id])
  @@index([memory_id, related_memory_id])
  @@index([similarity_score])
  @@index([relation_type])
  @@map("memory_relations")
}

model MemorySnapshot {
  id           String   @id @default(uuid()) @db.Uuid
  user_id      String   @db.Uuid
  raw_text     String
  created_at   DateTime @default(now())
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([user_id, created_at])
  @@map("memory_snapshots")
}

/// Each search query event (stores only hashed embedding reference)
model QueryEvent {
  id             String               @id @default(uuid()) @db.Uuid
  user_id        String
  query          String
  embedding_hash String
  created_at     DateTime             @default(now())
  related        QueryRelatedMemory[]

  @@index([user_id])
  @@index([user_id, created_at])
  @@map("query_events")
}

/// Links a query event to matching memories
model QueryRelatedMemory {
  id             String     @id @default(uuid()) @db.Uuid
  query_event_id String     @db.Uuid
  memory_id      String     @db.Uuid
  rank           Int
  score          Float
  created_at     DateTime   @default(now())
  query_event    QueryEvent @relation(fields: [query_event_id], references: [id], onDelete: Cascade)
  memory         Memory     @relation(fields: [memory_id], references: [id], onDelete: Cascade)

  @@unique([query_event_id, memory_id])
  @@map("query_related_memories")
}

model TokenUsage {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  operation_type String
  input_tokens  Int
  output_tokens Int
  model_used   String?
  created_at    DateTime @default(now())
  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([created_at])
  @@index([user_id, created_at])
  @@index([operation_type])
  @@map("token_usage")
}

model UserProfile {
  id                  String   @id @default(uuid()) @db.Uuid
  user_id             String   @unique @db.Uuid
  static_profile_json Json?
  static_profile_text String? @db.Text
  dynamic_profile_json Json?
  dynamic_profile_text String? @db.Text
  last_updated        DateTime @default(now()) @updatedAt
  last_memory_analyzed DateTime?
  version             Int      @default(1)
  user                User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([last_updated])
  @@map("user_profiles")
}

model BrowsingSummary {
  id                 String   @id @default(uuid()) @db.Uuid
  user_id            String   @db.Uuid
  period_type        String
  period_start       DateTime
  period_end         DateTime
  wow_facts          Json?
  narrative_summary  String?  @db.Text
  domain_stats       Json?
  topics_explored    Json?
  categories_explored Json?
  time_estimates     Json?
  key_insights       Json?
  memory_ids         Json?
  created_at         DateTime @default(now())
  updated_at         DateTime @default(now()) @updatedAt
  user               User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([period_type])
  @@index([period_start])
  @@index([period_end])
  @@index([user_id, period_type])
  @@index([user_id, period_type, period_start])
  @@map("browsing_summaries")
}

model IntelligenceBriefing {
  id              String       @id @default(uuid()) @db.Uuid
  user_id         String       @db.Uuid
  organization_id String?      @db.Uuid
  briefing_type   BriefingType
  period_start    DateTime
  period_end      DateTime
  summary         String       @db.Text
  topics          Json
  wow_facts       Json?
  knowledge_gaps  Json?
  connections     Json?
  expert_updates  Json?
  read_at         DateTime?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @default(now()) @updatedAt

  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([user_id, briefing_type, period_start])
  @@index([organization_id, briefing_type, period_start])
  @@index([user_id, created_at])
  @@map("intelligence_briefings")
}

model NotificationPreferences {
  id               String  @id @default(uuid()) @db.Uuid
  user_id          String  @unique @db.Uuid
  daily_digest     Boolean @default(true)
  weekly_synthesis Boolean @default(true)
  trend_alerts     Boolean @default(true)
  team_reports     Boolean @default(true)
  digest_hour      Int     @default(18)
  timezone         String  @default("UTC")
  created_at       DateTime @default(now())
  updated_at       DateTime @default(now()) @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Meeting {
  id               String        @id @default(uuid()) @db.Uuid
  user_id          String        @db.Uuid
  organization_id  String?       @db.Uuid
  meeting_url      String
  platform         String        // 'google_meet' | 'zoom'
  bot_session_id   String?
  calendar_event_id String?      // Google Calendar event ID if auto-joined
  status           MeetingStatus @default(JOINING)
  title            String?
  raw_transcript   Json?         // TranscriptSegment[]
  summary          String?       @db.Text
  action_items     Json?         // ActionItem[]
  topics           Json?         // Topic[]
  started_at       DateTime?
  ended_at         DateTime?
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  user             User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization     Organization? @relation(fields: [organization_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([organization_id])
  @@index([status])
  @@index([calendar_event_id])
  @@index([user_id, created_at])
  @@map("meetings")
}

